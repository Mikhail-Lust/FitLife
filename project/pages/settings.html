<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitLife - –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
  <link rel="stylesheet" href="../styles/settings_html.css">
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
</head>
<body>
  <header>
    <div class="profile">
      <img src="https://i.pravatar.cc/45" class="profile-img" id="userPhoto" alt="–ü—Ä–æ—Ñ–∏–ª—å">
      <span id="username">–ì–æ—Å—Ç—å</span>
    </div>
    <div class="burger" onclick="toggleMenu()">‚ò∞</div>
  </header>

  <nav class="menu" id="menu">
    <a href="index.html" onclick="closeMenu()">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="diet.html" onclick="closeMenu()">ü•ó –î–∏–µ—Ç–∞</a>
    <a href="workout.html" onclick="closeMenu()">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</a>
    <a href="progress.html" onclick="closeMenu()">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</a>
    <a href="settings.html" onclick="closeMenu()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </nav>

  <main class="main">
    <div class="settings-list">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>

      <div class="setting-item">
        <div>
          <h3>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</h3>
          <p>–í–∫–ª—é—á–∏—Ç—å –Ω–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</p>
        </div>
        <label class="switch">
          <input type="checkbox" id="darkTheme">
          <span class="slider"></span>
        </label>
      </div>

      <div class="setting-item">
        <div>
          <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
          <p>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
        </div>
        <label class="switch">
          <input type="checkbox" id="notifications">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script>
    const vkBridge = window.VKBridge.default;

  // Sends event to client
  vkBridge.send('VKWebAppInit')

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function fetchUserData() {
      try {
        const user = await vkBridge.send('VKWebAppGetUserInfo');
        document.getElementById('username').textContent = `${user.first_name} ${user.last_name}`;
        document.getElementById('userPhoto').src = user.photo_200 || 'https://i.pravatar.cc/45';
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        document.getElementById('userPhoto').src = 'https://i.pravatar.cc/45';
        document.getElementById('username').textContent = '–ì–æ—Å—Ç—å';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    async function loadSettings() {
      try {
        const [theme, notifications] = await Promise.all([
          vkBridge.send('VKWebAppStorageGet', {keys: ['theme']}),
          vkBridge.send('VKWebAppStorageGet', {keys: ['notifications']})
        ]);

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
        const currentTheme = theme.keys[0]?.value || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.getElementById('darkTheme').checked = currentTheme === 'dark';

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        document.getElementById('notifications').checked =
          notifications.keys[0]?.value === 'true';

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–º—ã
      document.getElementById('darkTheme').addEventListener('change', async e => {
        const theme = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        try {
          await vkBridge.send('VKWebAppStorageSet', {key: 'theme', value: theme});
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã:', error);
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      document.getElementById('notifications').addEventListener('change', async e => {
        if(e.target.checked) {
          try {
            // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            const result = await vkBridge.send('VKWebAppAllowNotifications');
            if(result.result) {
              await vkBridge.send('VKWebAppStorageSet',
                {key: 'notifications', value: 'true'});
              return;
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
          }
          // –ï—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
          e.target.checked = false;
          await vkBridge.send('VKWebAppStorageSet',
            {key: 'notifications', value: 'false'});
        } else {
          await vkBridge.send('VKWebAppStorageSet',
            {key: 'notifications', value: 'false'});
        }
      });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é
    function toggleMenu() {
      document.getElementById('menu').classList.toggle('active');
    }

    function closeMenu() {
      document.getElementById('menu').classList.remove('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>